# ğŸ‰ åŠŸèƒ½æ¢å¾©å®Œæˆç¸½çµ

## ğŸ“‹ å·²æ¢å¾©çš„æ ¸å¿ƒåŠŸèƒ½

### 1. ğŸ” æ™ºèƒ½è·¯å¾‘æª¢æŸ¥åŠŸèƒ½
- **åŠŸèƒ½æè¿°**: å€åˆ†è·¯å¾‘çš„ç™¼å±•éšæ®µï¼Œæ™ºèƒ½åˆ¤æ–·è·¯å¾‘æ˜¯å¦æº–å‚™å¥½é€²è¡Œç§»å‹•
- **è·¯å¾‘éšæ®µ**:
  - `complete`: å®Œæ•´è·¯å¾‘å­˜åœ¨ï¼Œå¯ä»¥ç«‹å³ç§»å‹•
  - `partial`: éƒ¨åˆ†è·¯å¾‘å­˜åœ¨ï¼ˆæ‰¹æ¬¡æˆ–ç«™é»ç›®éŒ„ï¼‰ï¼Œéœ€è¦ç­‰å¾…
  - `base`: åŸºç¤ç›®éŒ„å­˜åœ¨ï¼Œè·¯å¾‘æ­£åœ¨æ§‹å»ºä¸­
  - `none`: è·¯å¾‘å®Œå…¨ä¸å­˜åœ¨
- **å¯¦ç¾ä½ç½®**: `DataProcessor._check_path_development_stage()`
- **æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé

### 2. ğŸ”„ å»¶é²é‡è©¦æ©Ÿåˆ¶
- **åŠŸèƒ½æè¿°**: è‡ªå‹•é‡è©¦å¤±æ•—çš„ç§»å‹•æ“ä½œï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿ç­–ç•¥
- **é‡è©¦ç­–ç•¥**:
  - æœ€å¤§é‡è©¦æ¬¡æ•¸: 5æ¬¡
  - é‡è©¦é–“éš”: 5åˆ†é˜ â†’ 10åˆ†é˜ â†’ 20åˆ†é˜ â†’ 40åˆ†é˜ â†’ 1å°æ™‚
  - è‡ªå‹•æ¸…ç†: è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸å¾Œå¾éšŠåˆ—ä¸­ç§»é™¤
- **å¯¦ç¾ä½ç½®**: 
  - `DataProcessor._add_to_retry_queue()`
  - `DataProcessor._process_retry_queue()`
  - `DataProcessor._retry_component_move()`
- **æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé

### 3. ğŸ“Š è·¯å¾‘ç›£æ§åŠŸèƒ½
- **åŠŸèƒ½æè¿°**: æŒçºŒç›£æ§è·¯å¾‘å®Œæˆç‹€æ…‹ï¼Œè‡ªå‹•è§¸ç™¼ç§»å‹•
- **ç›£æ§é‚è¼¯**:
  - æ¯10ç§’æª¢æŸ¥è·¯å¾‘å®Œæˆç‹€æ…‹
  - è·¯å¾‘å®Œæˆæ™‚è‡ªå‹•è§¸ç™¼ç§»å‹•
  - ç§»å‹•å¤±æ•—æ™‚è‡ªå‹•æ·»åŠ åˆ°é‡è©¦éšŠåˆ—
- **å¯¦ç¾ä½ç½®**:
  - `DataProcessor._monitor_path_completion()`
  - `DataProcessor._check_path_completion()`
- **æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé

### 4. ğŸš€ è‡ªå‹•è§¸ç™¼ç§»å‹•
- **åŠŸèƒ½æè¿°**: ç•¶è·¯å¾‘å®Œæˆæ™‚è‡ªå‹•è§¸ç™¼ç§»å‹•ï¼Œç„¡éœ€æ‰‹å‹•å¹²é 
- **è§¸ç™¼æ¢ä»¶**: æ‰€æœ‰æ–‡ä»¶é¡å‹ï¼ˆORG/ROIï¼‰çš„è·¯å¾‘éƒ½å®Œæˆ
- **å¯¦ç¾ä½ç½®**: `DataProcessor._monitor_path_completion()` ä¸­çš„è‡ªå‹•ç§»å‹•é‚è¼¯
- **æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé

## ğŸ”§ æŠ€è¡“å¯¦ç¾ç´°ç¯€

### è·¯å¾‘æª¢æŸ¥é‚è¼¯
```python
def _check_path_development_stage(self, base_path: Path, target_path: Path) -> str:
    if target_path.exists():
        return "complete"      # å®Œæ•´è·¯å¾‘å­˜åœ¨
    elif target_path.parent.exists():
        return "partial"       # éƒ¨åˆ†è·¯å¾‘å­˜åœ¨
    elif base_path.exists():
        return "base"          # åŸºç¤ç›®éŒ„å­˜åœ¨
    else:
        return "none"          # å®Œå…¨ä¸å­˜åœ¨
```

### é‡è©¦éšŠåˆ—ç®¡ç†
```python
def _add_to_retry_queue(self, component_id: str, ...):
    # æ·»åŠ åˆ°é‡è©¦éšŠåˆ—ï¼Œè¨­ç½®é‡è©¦æ™‚é–“å’Œæ¬¡æ•¸
    self.retry_queue[component_id] = {
        'retry_time': datetime.datetime.now() + datetime.timedelta(seconds=retry_delay),
        'retry_count': 0,
        'max_retries': 5
    }
```

### è·¯å¾‘ç›£æ§è§¸ç™¼
```python
def _monitor_path_completion(self, component_id: str, ...):
    # æª¢æŸ¥æ‰€æœ‰è·¯å¾‘å®Œæˆç‹€æ…‹
    if all_paths_complete:
        # è‡ªå‹•è§¸ç™¼ç§»å‹•
        success, message = self.move_files(...)
        if success:
            # å¾ç›£æ§åˆ—è¡¨ä¸­ç§»é™¤
            del self.path_monitors[component_id]
```

## ğŸ“ æ–‡ä»¶ä¿®æ”¹è¨˜éŒ„

### ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `dbmplus/app/controllers/data_processor.py`
  - æ·»åŠ æ™ºèƒ½è·¯å¾‘æª¢æŸ¥æ–¹æ³•
  - å¯¦ç¾å»¶é²é‡è©¦æ©Ÿåˆ¶
  - æ·»åŠ è·¯å¾‘ç›£æ§åŠŸèƒ½
  - ä¿®æ”¹ `move_files` æ–¹æ³•ä½¿ç”¨æ™ºèƒ½æª¢æŸ¥

### æ–°å¢æ¸¬è©¦æ–‡ä»¶
- `dbmplus/scripts/test_smart_path_check.py` - æ¸¬è©¦æ™ºèƒ½è·¯å¾‘æª¢æŸ¥åŠŸèƒ½

## ğŸ¯ è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ

### 1. è·¯å¾‘ä¸å®Œæ•´å°è‡´çš„ç§»å‹•å¤±æ•—
- **å•é¡Œ**: CSVè™•ç†å®Œæˆæ™‚ï¼ŒORG/ROIè·¯å¾‘å¯èƒ½é‚„åœ¨æ§‹å»ºä¸­
- **è§£æ±º**: æ™ºèƒ½è·¯å¾‘æª¢æŸ¥ï¼Œå€åˆ†è·¯å¾‘ç™¼å±•éšæ®µ

### 2. ç§»å‹•å¤±æ•—å¾Œç„¡æ³•é‡è©¦
- **å•é¡Œ**: ç§»å‹•å¤±æ•—å¾Œçµ„ä»¶ä¸Ÿå¤±ï¼Œç„¡æ³•å¾ŒçºŒè™•ç†
- **è§£æ±º**: å»¶é²é‡è©¦æ©Ÿåˆ¶ï¼Œè‡ªå‹•é‡è©¦å¤±æ•—çš„ç§»å‹•

### 3. è·¯å¾‘å®Œæˆå¾Œç„¡æ³•è‡ªå‹•è§¸ç™¼
- **å•é¡Œ**: è·¯å¾‘å®Œæˆå¾Œéœ€è¦æ‰‹å‹•è§¸ç™¼ç§»å‹•
- **è§£æ±º**: è·¯å¾‘ç›£æ§åŠŸèƒ½ï¼Œè‡ªå‹•è§¸ç™¼ç§»å‹•

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å•Ÿç”¨æ™ºèƒ½è·¯å¾‘æª¢æŸ¥
```python
# åœ¨ move_files æ–¹æ³•ä¸­è‡ªå‹•ä½¿ç”¨
path_stage = self._check_path_development_stage(base_path, source_path)

if path_stage == "complete":
    # ç«‹å³ç§»å‹•
    shutil.move(str(source_path), str(target_path))
elif path_stage == "partial":
    # æ·»åŠ åˆ°è·¯å¾‘ç›£æ§
    self._monitor_path_completion(...)
else:
    # æ·»åŠ åˆ°é‡è©¦éšŠåˆ—
    self._add_to_retry_queue(...)
```

### æ‰‹å‹•æ·»åŠ çµ„ä»¶åˆ°é‡è©¦éšŠåˆ—
```python
data_processor._add_to_retry_queue(
    component_id="WLPF80030004",
    lot_id="temp_WLPF800300",
    station="RDL",
    source_product="temp",
    target_product="i-Pixel",
    file_types=["org", "roi"],
    reason="è·¯å¾‘ä¸å­˜åœ¨",
    retry_delay=300  # 5åˆ†é˜å¾Œé‡è©¦
)
```

### æ‰‹å‹•ç›£æ§è·¯å¾‘å®Œæˆ
```python
data_processor._monitor_path_completion(
    component_id="WLPF80030004",
    lot_id="temp_WLPF800300",
    station="RDL",
    source_product="temp",
    target_product="i-Pixel",
    file_types=["org", "roi"]
)
```

## ğŸ“Š æ€§èƒ½å„ªåŒ–

### å®šæ™‚å™¨è¨­ç½®
- **é‡è©¦éšŠåˆ—æª¢æŸ¥**: æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
- **è·¯å¾‘ç›£æ§æª¢æŸ¥**: æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡
- **å¯é…ç½®**: é€šéé…ç½®æ–‡ä»¶èª¿æ•´æª¢æŸ¥é »ç‡

### å…§å­˜ç®¡ç†
- **è‡ªå‹•æ¸…ç†**: æˆåŠŸå¾Œè‡ªå‹•å¾ç›£æ§åˆ—è¡¨å’Œé‡è©¦éšŠåˆ—ä¸­ç§»é™¤
- **æœ€å¤§é™åˆ¶**: é‡è©¦æ¬¡æ•¸é™åˆ¶ï¼Œé¿å…ç„¡é™é‡è©¦

## ğŸ”® æœªä¾†æ“´å±•

### å¯é…ç½®åƒæ•¸
- é‡è©¦é–“éš”æ™‚é–“
- æœ€å¤§é‡è©¦æ¬¡æ•¸
- è·¯å¾‘ç›£æ§é »ç‡
- è·¯å¾‘å®Œæˆè¶…æ™‚æ™‚é–“

### ç›£æ§å’Œå ±å‘Š
- é‡è©¦éšŠåˆ—ç‹€æ…‹å ±å‘Š
- è·¯å¾‘ç›£æ§çµ±è¨ˆ
- ç§»å‹•æˆåŠŸç‡çµ±è¨ˆ
- æ€§èƒ½æŒ‡æ¨™ç›£æ§

## âœ… æ¸¬è©¦é©—è­‰

### æ¸¬è©¦è…³æœ¬
- `test_smart_path_check.py` - é©—è­‰æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- `test_delayed_move_debug.py` - é©—è­‰è©³ç´°è·¯å¾‘èª¿è©¦

### æ¸¬è©¦çµæœ
- æ™ºèƒ½è·¯å¾‘æª¢æŸ¥: âœ… é€šé
- å»¶é²é‡è©¦æ©Ÿåˆ¶: âœ… é€šé
- è·¯å¾‘ç›£æ§åŠŸèƒ½: âœ… é€šé
- è‡ªå‹•è§¸ç™¼ç§»å‹•: âœ… é€šé

## ğŸ‰ ç¸½çµ

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²æˆåŠŸæ¢å¾©ä¸¦é€šéæ¸¬è©¦é©—è­‰ï¼š

1. **æ™ºèƒ½è·¯å¾‘æª¢æŸ¥** - è§£æ±ºè·¯å¾‘ä¸å®Œæ•´çš„å•é¡Œ
2. **å»¶é²é‡è©¦æ©Ÿåˆ¶** - ç¢ºä¿ç§»å‹•å¤±æ•—å¾Œèƒ½é‡è©¦
3. **è·¯å¾‘ç›£æ§åŠŸèƒ½** - è‡ªå‹•ç›£æ§è·¯å¾‘å®Œæˆç‹€æ…‹
4. **è‡ªå‹•è§¸ç™¼ç§»å‹•** - è·¯å¾‘å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œç§»å‹•

é€™äº›åŠŸèƒ½å°‡å¤§å¤§æé«˜æ–‡ä»¶ç§»å‹•çš„å¯é æ€§å’Œè‡ªå‹•åŒ–ç¨‹åº¦ï¼Œè§£æ±ºä¹‹å‰é‡åˆ°çš„"æ‰¾ä¸åˆ°çµ„ä»¶"å’Œç§»å‹•å¤±æ•—çš„å•é¡Œã€‚
